---
- name: ec2_vpc_igw tests
  collections:
    - amazon.aws

  module_defaults:
    group/aws:
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      security_token: "{{ security_token | default(omit) }}"
      region: "{{ aws_region }}"
  block:
  # ============================================================
  - name: Fetch Peers in check_mode
    ec2_vpc_peering_info:
    register: peers_info
    check_mode: True
  - name: Assert success
    assert:
      that:
        - peers_info is successful
        - '"result" in peers_info'

  # ============================================================
  - name: create VPC 1
    ec2_vpc_net:
      name: "{{ vpc_1_name }}"
      state: present
      cidr_block: "{{ vpc_1_cidr }}"
      tags:
        Name: "{{ vpc_1_name }}"
        TestPrefex: "{{ resource_prefix }}"
    register: vpc_1_result
  - name: Assert success
    assert:
      that:
        - vpc_1_result is successful

  - name: create VPC 2
    ec2_vpc_net:
      name: "{{ vpc_2_name }}"
      state: present
      cidr_block: "{{ vpc_2_cidr }}"
      tags:
        Name: "{{ vpc_2_name }}"
        TestPrefex: "{{ resource_prefix }}"
    register: vpc_2_result
  - name: Assert success
    assert:
      that:
        - vpc_2_result is successful

  - name: Store VPC IDs
    set_fact:
      vpc_1: '{{ vpc_1_result.vpc.id }}'
      vpc_2: '{{ vpc_2_result.vpc.id }}'

  - name: Create local account VPC peering Connection
    ec2_vpc_peer:
      vpc_id: '{{ vpc_1 }}'
      peer_vpc_id: '{{ vpc_2 }}'
      state: present
      tags:
        Name: 'Peering connection for VPC {{ vpc_1 }} to VPC {{ vpc_2 }}'
    register: vpc_peer
  - name: Assert success
    assert:
      that:
        - vpc_peer is changed
        - vpc_peer is successful
        - "'peering_id' in vpc_peer"
        - vpc_peer.peering_id.startswith('pcx-')

  - name: Store Connection ID
    set_fact:
      peer_id_1: '{{ vpc_peer.peering_id }}'

  - name: (re-) Create local account VPC peering Connection (idempotency)
    ec2_vpc_peer:
      vpc_id: '{{ vpc_1 }}'
      peer_vpc_id: '{{ vpc_2 }}'
      state: present
      tags:
        Name: 'Peering connection for VPC {{ vpc_1 }} to VPC {{ vpc_2 }}'
    register: vpc_peer
  - name: Assert success
    assert:
      that:
        - vpc_peer is not changed
        - vpc_peer is successful
        - vpc_peer.peering_id == peer_id_1

  - name: Get details on specific VPC peer
    ec2_vpc_peering_info:
      peer_connection_ids:
        - '{{ vpc_peer.peering_id }}'
    register: peer_info

  - name: Get all vpc peers with specific filters
    ec2_vpc_peering_info:
      filters:
        status-code: ['pending-acceptance']
    register: pending_vpc_peers

  - name: Update tags on the VPC Peering Connection
    ec2_vpc_peer:
      vpc_id: '{{ vpc_1 }}'
      peer_vpc_id: '{{ vpc_2 }}'
      state: present
      tags:
        Name: 'Peering connection for VPC {{ vpc_1 }} to VPC {{ vpc_2 }}'
        testPrefix: '{{ resource_prefix }}'
    register: tag_peer
  - name: Assert success
    assert:
      that:
        - tag_peer is changed
        - tag_peer is successful
        - tag_peer.peering_id == peer_id_1

  - name: (re-) Update tags on the VPC Peering Connection (idempotency)
    ec2_vpc_peer:
      vpc_id: '{{ vpc_1 }}'
      peer_vpc_id: '{{ vpc_2 }}'
      state: present
      tags:
        Name: 'Peering connection for VPC {{ vpc_1 }} to VPC {{ vpc_2 }}'
        testPrefix: '{{ resource_prefix }}'
    register: tag_peer
  - name: Assert success
    assert:
      that:
        - tag_peer is not changed
        - tag_peer is successful
        - tag_peer.peering_id == peer_id_1

  - name: Get details on specific VPC peer
    ec2_vpc_peering_info:
      peer_connection_ids:
        - '{{ vpc_peer.peering_id }}'
    register: peer_info

  - name: Accept local VPC peering request
    ec2_vpc_peer:
      peering_id: "{{ vpc_peer.peering_id }}"
      state: accept
    register: action_peer
  - name: Assert success
    assert:
      that:
        - action_peer is changed
        - action_peer is successful
        - action_peer.peering_id == peer_id_1

  - name: Get details on specific VPC peer
    ec2_vpc_peering_info:
      peer_connection_ids:
        - '{{ vpc_peer.peering_id }}'
    register: peer_info

  - name: (re-) Accept local VPC peering request (idempotency)
    ec2_vpc_peer:
      peering_id: "{{ vpc_peer.peering_id }}"
      state: accept
    register: action_peer
  - name: Assert success
    assert:
      that:
        - action_peer is not changed
        - action_peer is successful
        - action_peer.peering_id == peer_id_1

  - name: delete a local VPC peering Connection
    ec2_vpc_peer:
      peering_id: "{{ vpc_peer.peering_id }}"
      state: absent
    register: delete_peer
  - name: Assert success
    assert:
      that:
        - delete_peer is changed
        - delete_peer is successful

  - name: Get details on specific VPC peer
    ec2_vpc_peering_info:
      peer_connection_ids:
        - '{{ vpc_peer.peering_id }}'
    register: peer_info

  - name: (re-) delete a local VPC peering Connection (idempotency)
    ec2_vpc_peer:
      peering_id: "{{ vpc_peer.peering_id }}"
      state: absent
    register: delete_peer
  - name: Assert success
    assert:
      that:
        - delete_peer is not changed
        - delete_peer is successful

  - name: Create local account VPC peering Connection
    ec2_vpc_peer:
      vpc_id: '{{ vpc_1 }}'
      peer_vpc_id: '{{ vpc_2 }}'
      state: present
      tags:
        Name: 'Peering connection for VPC {{ vpc_1 }} to VPC {{ vpc_2 }}'
    register: vpc_peer2
  - name: Assert success
    assert:
      that:
        - vpc_peer2 is changed
        - vpc_peer2 is successful
        - "'peering_id' in vpc_peer2"
        - vpc_peer2.peering_id.startswith('pcx-')

  - name: Store Connection ID
    set_fact:
      peer_id_2: '{{ vpc_peer2.peering_id }}'

  - name: reject a local VPC peering Connection
    ec2_vpc_peer:
      peering_id: "{{ vpc_peer2.peering_id }}"
      state: reject
    register: reject_peer
  - name: Assert success
    assert:
      that:
        - reject_peer is changed
        - reject_peer is successful
        - reject_peer.peering_id == peer_id_2

  - name: (re-) reject a local VPC peering Connection
    ec2_vpc_peer:
      peering_id: "{{ vpc_peer2.peering_id }}"
      state: reject
    register: reject_peer
  - name: Assert success
    assert:
      that:
        - reject_peer is not changed
        - reject_peer is successful
        - reject_peer.peering_id == peer_id_2

  - name: delete a local VPC peering Connection
    ec2_vpc_peer:
      peering_id: "{{ vpc_peer2.peering_id }}"
      state: absent
    register: delete_peer
  - name: Assert success
    assert:
      that:
        - delete_peer is not changed
        - delete_peer is successful

  always:
    # ============================================================

  - name: delete a local VPC peering Connection
    ec2_vpc_peer:
      peering_id: "{{ vpc_peer.peering_id }}"
      state: absent
    register: delete_peer
    ignore_errors: True

  - name: delete a local VPC peering Connection
    ec2_vpc_peer:
      peering_id: "{{ vpc_peer2.peering_id }}"
      state: absent
    register: delete_peer
    ignore_errors: True

  - name: tidy up VPC 2
    ec2_vpc_net:
      name: "{{ vpc_2_name }}"
      state: absent
      cidr_block: "{{ vpc_2_cidr }}"
    ignore_errors: true

  - name: tidy up VPC 1
    ec2_vpc_net:
      name: "{{ vpc_1_name }}"
      state: absent
      cidr_block: "{{ vpc_1_cidr }}"
    ignore_errors: true
