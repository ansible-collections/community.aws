---

- name: Integration testing for the cloudfront_origin_request_policy module
  module_defaults:
    group/aws:
      aws_access_key: '{{ aws_access_key }}'
      aws_secret_key: '{{ aws_secret_key }}'
      security_token: '{{ security_token | default(omit) }}'
      region: '{{ aws_region }}'
  block:

    - name: Create a simple origin request policy
      cloudfront_origin_request_policy:
        name: "{{ resource_prefix }}-my-origin-request-policy"
        comment: Created by Ansible test
        headers_config:
          header_behavior: none
        cookies_config:
          cookie_behavior: none
        query_strings_config:
          query_string_behavior: none
        state: present
      register: create_result

    - name: Assert creation without errors and return values
      assert:
        that:
          - create_result is changed
          - create_result is not failed
          - create_result.origin_request_policy.origin_request_policy_config.name == "{{ resource_prefix }}-my-origin-request-policy"

    - name: Rerun same task to ensure idempotence
      cloudfront_origin_request_policy:
        name: "{{ resource_prefix }}-my-origin-request-policy"
        comment: Created by Ansible test
        headers_config:
          header_behavior: none
        cookies_config:
          cookie_behavior: none
        query_strings_config:
          query_string_behavior: none
        state: present
      register: rerun_result

    - name: Assert no change and no errors
      assert:
        that:
          - rerun_result is not changed
          - rerun_result is not failed

    - name: Update existing policy with more complicated configuration
      cloudfront_origin_request_policy:
        name: "{{ resource_prefix }}-my-origin-request-policy"
        comment: Created by Ansible test
        headers_config:
          header_behavior: whitelist
          headers:
            items:
              - accept
              - accept-language
              - host
              - user-agent
        cookies_config:
          cookie_behavior: whitelist
          cookies:
            items:
              - my-cookie
        query_strings_config:
          query_string_behavior: whitelist
          query_strings:
            items:
              - my-query-string
        state: present
      register: update_result

    - name: Assert update and updated return values
      assert:
        that:
          - update_result is changed
          - update_result.origin_request_policy.origin_request_policy_config.headers_config.header_behavior == 'whitelist'
          - update_result.origin_request_policy.origin_request_policy_config.cookies_config.cookie_behavior == 'whitelist'

    - name: Ensure policy is deleted
      cloudfront_origin_request_policy:
        name: "{{ resource_prefix }}-my-origin-request-policy"
        comment: Created by Ansible test
        state: absent
      register: delete_result

    - name: Assert deletion without errors
      assert:
        that:
          - delete_result is changed
          - delete_result is not failed
          - update_result.origin_request_policy is undefined

  always:

    - name: Ensure policy is deleted
      cloudfront_origin_request_policy:
        name: "{{ resource_prefix }}-my-origin-request-policy"
        state: absent
      ignore_errors: true