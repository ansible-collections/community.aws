---
- name: Run elb_target_group protocol_version tests
  block:
    - name: Create a target group with protocol_version 'GRPC'
      community.aws.elb_target_group:
        name: "{{ elb_target_group_name }}-protocol_version_test"
        protocol: http
        port: 80
        vpc_id: "{{ vpc.vpc.id }}"
        protocol_version: GRPC
        state: present
      register: create_result

    - debug: msg="{{ create_result }}"

    - assert:
        that:
          - create_result is changed
          - create_result is not failed

    - name: Create a target group with protocol_version 'GRPC' (idempotence)
      community.aws.elb_target_group:
        name: "{{ elb_target_group_name }}-protocol_version_test"
        protocol: http
        port: 80
        vpc_id: "{{ vpc.vpc.id }}"
        protocol_version: GRPC
        state: present
      register: create_result

    - debug: msg="{{ create_result }}"

    - assert:
        that:
          - create_result is not changed
          - create_result is not failed

  always:
    - name: Remove elb target group
      elb_target_group:
        name: "{{ elb_target_group_name }}-protocol_version_test"
        state: absent
      ignore_errors: true
      register: deletion_result

    - name: Ensure elb_target_group deletion
      assert:
        that:
          - deletion_result is changed
          - deletion_result is not failed
