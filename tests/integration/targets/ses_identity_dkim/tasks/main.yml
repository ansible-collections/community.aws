---
# tasks file for ses_identity_dkim test

- name: Set AWS module defaults
  module_defaults:
    aws_ses_identity:
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      security_token: "{{ security_token | default(omit) }}"
      region: "{{ aws_region }}"
  no_log: yes

- block:


    ## prepare SES identity to run tests on

    - name: Create SES identity for running DKIM module tests on (domain identity)
      aws_ses_identity:
        identity: "{{ dkim_identity_domain }}"
        state: present
      register: ses_domain_identity

    - name: Create SES identity for running DKIM module tests on (email identity)
      aws_ses_identity:
        identity: "{{ dkim_identity_email }}"
        state: present
      register: ses_email_identity

    ## DKIM enable test

    - name: Enable DKIM verification on domain identity
      ses_identity_dkim:
        identity: "{{ dkim_identity_domain }}"
        state: enabled
      register: domain_result

    - name: assert successful result
      assert:
        that:
          - domain_result.changed == True
          - domain_result.dkim_attributes.dkim_enabled == True
          - domain_result.dkim_attributes.dkim_tokens|length > 0

    - name: Enable DKIM verification on email identity
      ses_identity_dkim:
        identity: "{{ dkim_identity_email }}"
        state: enabled
      register: email_result

    - name: assert successful result
      assert:
        that:
          - email_result.changed == True
          - email_result.dkim_attributes.dkim_enabled == True
          - email_result.dkim_attributes.dkim_tokens|length > 0

    ## DKIM enable idempotence test (rerun)

    - name: Enable DKIM verification on domain identity (rerun)
      ses_identity_dkim:
        identity: "{{ dkim_identity_domain }}"
        state: enabled
      register: domain_result

    - name: assert no change (itempotence)
      assert:
        that:
          - domain_result.changed == False
          - domain_result.dkim_attributes.dkim_enabled == True

    - name: Enable DKIM verification on email identity (rerun)
      ses_identity_dkim:
        identity: "{{ dkim_identity_email }}"
        state: enabled
      register: email_result

    - name: assert no change (idempotence)
      assert:
        that:
          - email_result.changed == False
          - email_result.dkim_attributes.dkim_enabled == True

    ## DKIM disable test

    - name: Disable DKIM verification on domain identity
      ses_identity_dkim:
        identity: "{{ dkim_identity_domain }}"
        state: disabled
      register: domain_result

    - name: assert result changed
      assert:
        that:
          - domain_result.changed == True
          - domain_result.dkim_attributes.dkim_enabled == False

    - name: Disable DKIM verification on email identity
      ses_identity_dkim:
        identity: "{{ dkim_identity_email }}"
        state: disabled
      register: email_result

    - name: assert result changed
      assert:
        that:
          - email_result.changed == True
          - email_result.dkim_attributes.dkim_enabled == False

    ## DKIM disable idempotence test (rerun)

    - name: Disable DKIM verification on domain identity (rerun)
      ses_identity_dkim:
        identity: "{{ dkim_identity_domain }}"
        state: disabled
      register: domain_result

    - name: assert result changed
      assert:
        that:
          - domain_result.changed == False
          - domain_result.dkim_attributes.dkim_enabled == False

    - name: Disable DKIM verification on email identity (rerun)
      ses_identity_dkim:
        identity: "{{ dkim_identity_email }}"
        state: disabled
      register: email_result

    - name: assert result changed
      assert:
        that:
          - email_result.changed == False
          - email_result.dkim_attributes.dkim_enabled == False


  always:
    ## ensure cleanup

    - name: Delete SES testing identity again
      aws_ses_identity:
        identity: "{{ item }}"
        state: absent
      with_items:
        - '{{ dkim_identity_domain }}'
        - '{{ dkim_identity_email }}'
        # DKIM verifictation for emails registers the domain
        # as an identity too, so it must be cleaned up.
        - '{{ dkim_identity_email_domain }}'
      ignore_errors: yes
