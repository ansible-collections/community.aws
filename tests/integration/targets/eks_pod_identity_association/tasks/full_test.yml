####
# Create
- name: Create pod identity association (check mode)
  community.aws.eks_pod_identity_association:
    cluster_name: '{{ eks_cluster_name }}'
    role_arn: "{{ pod_identity_association_role.arn }}"
    taregt_role_arn: "{{ pod_identity_association_role.arn | replace(account_id, '123456789012') }}"
    namespace: "{{ k8s_namespace }}"
    service_account: "{{ k8s_service_account }}"
    tags:
      'foo': 'bar'
    state: present
  register: pod_identity_result
  variables:
    account_id: "{{ (pod_identity_association_role.arn | split(':'))[2] }}"
  environment:
    AWS_DEFAULT_REGION: 'us-east-1'
  check_mode: True

- name: check that eks_pod_identity_association is created (check mode)
  assert:
    that:
      - pod_identity_result.changed


- name: Create pod identity association
  community.aws.eks_pod_identity_association:
    cluster_name: '{{ eks_cluster_name }}'
    role_arn: "{{ pod_identity_association_role.arn }}"
    taregt_role_arn: "{{ pod_identity_association_role.arn | replace(account_id, '123456789012') }}"
    namespace: "{{ k8s_namespace }}"
    service_account: "{{ k8s_service_account }}"
    tags:
      'foo': 'bar'
    state: present
  register: pod_identity_result
  variables:
    account_id: "{{ (pod_identity_association_role.arn | split(':'))[2] }}"
  environment:
    AWS_DEFAULT_REGION: 'us-east-1'

- name: check that eks_pod_identity_association is created
  assert:
    that:
      - pod_identity_result.changed

- name: Create pod identity association (idempotency)(check mode)
  community.aws.eks_pod_identity_association:
    cluster_name: '{{ eks_cluster_name }}'
    role_arn: "{{ pod_identity_association_role.arn }}"
    taregt_role_arn: "{{ pod_identity_association_role.arn | replace(account_id, '123456789012') }}"
    namespace: "{{ k8s_namespace }}"
    service_account: "{{ k8s_service_account }}"
    tags:
      'foo': 'bar'
    state: present
  register: pod_identity_result
  variables:
    account_id: "{{ (pod_identity_association_role.arn | split(':'))[2] }}"
  environment:
    AWS_DEFAULT_REGION: 'us-east-1'
  check_mode: True

- name: check that eks_pod_identity_association is not changed (idempotency)(check mode)
  assert:
    that:
      - not pod_identity_result.changed


- name: Create pod identity association (idempotency)
  community.aws.eks_pod_identity_association:
    cluster_name: '{{ eks_cluster_name }}'
    role_arn: "{{ pod_identity_association_role.arn }}"
    taregt_role_arn: "{{ pod_identity_association_role.arn | replace(account_id, '123456789012') }}"
    namespace: "{{ k8s_namespace }}"
    service_account: "{{ k8s_service_account }}"
    tags:
      'foo': 'bar'
    state: present
  register: pod_identity_result
  variables:
    account_id: "{{ (pod_identity_association_role.arn | split(':'))[2] }}"
  environment:
    AWS_DEFAULT_REGION: 'us-east-1'

- name: check that eks_pod_identity_association is not changed (idempotency)
  assert:
    that:
      - not pod_identity_result.changed

- name: Get pod identity association info
  community.aws.eks_pod_identity_association_info:
    cluster_name: '{{ eks_cluster_name }}'
    namespace: "{{ k8s_namespace }}"
    service_account: "{{ k8s_service_account }}"
  register: pod_identity_result_i1
  environment:
    AWS_DEFAULT_REGION: 'us-east-1'

- name: check that eks_pod_identity_association_info succeeds and returns same results
  assert:
    that:
      - pod_identity_result_i1.changed
      - pod_identity_result_i1.association_id == pod_identity_result.association_id

###
# Update ignored

- name: Test - attempt to update association with ignored parameter (tags) (check mode)
  community.aws.eks_pod_identity_association:
    cluster_name: '{{ eks_cluster_name }}'
    role_arn: "{{ pod_identity_association_role.arn }}"
    taregt_role_arn: "{{ pod_identity_association_role.arn | replace(account_id, '123456789012') }}"
    namespace: "{{ k8s_namespace }}"
    service_account: "{{ k8s_service_account }}"
    tags:
      'bar': 'foo'
    state: present
  register: pod_identity_result
  variables:
    account_id: "{{ (pod_identity_association_role.arn | split(':'))[2] }}"
  environment:
    AWS_DEFAULT_REGION: 'us-east-1'
  check_mode: True

- name: check that eks_pod_identity_association did nothing (check mode)
  assert:
    that:
      - not pod_identity_result.changed

- name: Test - attempt to update association with ignored parameter (tags)
  community.aws.eks_pod_identity_association:
    cluster_name: '{{ eks_cluster_name }}'
    role_arn: "{{ pod_identity_association_role.arn }}"
    taregt_role_arn: "{{ pod_identity_association_role.arn | replace(account_id, '123456789012') }}"
    namespace: "{{ k8s_namespace }}"
    service_account: "{{ k8s_service_account }}"
    tags:
      'bar': 'foo'
    state: present
  register: pod_identity_result
  variables:
    account_id: "{{ (pod_identity_association_role.arn | split(':'))[2] }}"
  environment:
    AWS_DEFAULT_REGION: 'us-east-1'

- name: check that eks_pod_identity_association did nothing
  assert:
    that:
      - not pod_identity_result.changed

###
# Update

- name: Test - attempt to update association with parameter (taregt_role_arn) (check mode)
  community.aws.eks_pod_identity_association:
    cluster_name: '{{ eks_cluster_name }}'
    role_arn: "{{ pod_identity_association_role.arn }}"
    taregt_role_arn: "{{ pod_identity_association_role.arn | replace(account_id, '120987654321') }}"
    namespace: "{{ k8s_namespace }}"
    service_account: "{{ k8s_service_account }}"
    tags:
      'foo': 'bar'
    state: present
  register: pod_identity_result
  variables:
    account_id: "{{ (pod_identity_association_role.arn | split(':'))[2] }}"
  environment:
    AWS_DEFAULT_REGION: 'us-east-1'
  check_mode: True

- name: check that eks_pod_identity_association is updated (check mode)
  assert:
    that:
      - pod_identity_result.changed

- name: Test - attempt to update association with parameter (taregt_role_arn)
  community.aws.eks_pod_identity_association:
    cluster_name: '{{ eks_cluster_name }}'
    role_arn: "{{ pod_identity_association_role.arn }}"
    taregt_role_arn: "{{ pod_identity_association_role.arn | replace(account_id, '120987654321') }}"
    namespace: "{{ k8s_namespace }}"
    service_account: "{{ k8s_service_account }}"
    tags:
      'foo': 'bar'
    state: present
  register: pod_identity_result
  variables:
    account_id: "{{ (pod_identity_association_role.arn | split(':'))[2] }}"
  environment:
    AWS_DEFAULT_REGION: 'us-east-1'

- name: check that eks_pod_identity_association is updated
  assert:
    that:
      - pod_identity_result.changed

- name: Test - attempt to update association with parameter (taregt_role_arn) (check mode)
  community.aws.eks_pod_identity_association:
    cluster_name: '{{ eks_cluster_name }}'
    role_arn: "{{ pod_identity_association_role.arn }}"
    taregt_role_arn: "{{ pod_identity_association_role.arn | replace(account_id, '120987654321') }}"
    namespace: "{{ k8s_namespace }}"
    service_account: "{{ k8s_service_account }}"
    tags:
      'foo': 'bar'
    state: present
  register: pod_identity_result
  variables:
    account_id: "{{ (pod_identity_association_role.arn | split(':'))[2] }}"
  environment:
    AWS_DEFAULT_REGION: 'us-east-1'
  check_mode: True

- name: check that eks_pod_identity_association did nothing (check mode)
  assert:
    that:
      - not pod_identity_result.changed

- name: Test - attempt to update association with parameter (taregt_role_arn) (idempotency)
  community.aws.eks_pod_identity_association:
    cluster_name: '{{ eks_cluster_name }}'
    role_arn: "{{ pod_identity_association_role.arn }}"
    taregt_role_arn: "{{ pod_identity_association_role.arn | replace(account_id, '120987654321') }}"
    namespace: "{{ k8s_namespace }}"
    service_account: "{{ k8s_service_account }}"
    tags:
      'foo': 'bar'
    state: present
  register: pod_identity_result
  variables:
    account_id: "{{ (pod_identity_association_role.arn | split(':'))[2] }}"
  environment:
    AWS_DEFAULT_REGION: 'us-east-1'

- name: check that eks_pod_identity_association did nothing
  assert:
    that:
      - not pod_identity_result.changed

###
# Delete

- name: Delete association (check mode)
  community.aws.eks_pod_identity_association:
    cluster_name: '{{ eks_cluster_name }}'
    role_arn: "{{ pod_identity_association_role.arn }}"
    taregt_role_arn: "{{ pod_identity_association_role.arn | replace(account_id, '120987654321') }}"
    namespace: "{{ k8s_namespace }}"
    service_account: "{{ k8s_service_account }}"
    tags:
      'foo': 'bar'
    state: absent
  register: pod_identity_result
  variables:
    account_id: "{{ (pod_identity_association_role.arn | split(':'))[2] }}"
  environment:
    AWS_DEFAULT_REGION: 'us-east-1'
  check_mode: True

- name: check that eks_pod_identity_association is deleted (check mode)
  assert:
    that:
      - pod_identity_result.changed

- name: Delete association
  community.aws.eks_pod_identity_association:
    cluster_name: '{{ eks_cluster_name }}'
    role_arn: "{{ pod_identity_association_role.arn }}"
    taregt_role_arn: "{{ pod_identity_association_role.arn | replace(account_id, '120987654321') }}"
    namespace: "{{ k8s_namespace }}"
    service_account: "{{ k8s_service_account }}"
    tags:
      'foo': 'bar'
    state: absent
  register: pod_identity_result
  variables:
    account_id: "{{ (pod_identity_association_role.arn | split(':'))[2] }}"
  environment:
    AWS_DEFAULT_REGION: 'us-east-1'

- name: check that eks_pod_identity_association is deleted
  assert:
    that:
      - pod_identity_result.changed

- name: Delete association (idempotency)(check mode)
  community.aws.eks_pod_identity_association:
    cluster_name: '{{ eks_cluster_name }}'
    role_arn: "{{ pod_identity_association_role.arn }}"
    taregt_role_arn: "{{ pod_identity_association_role.arn | replace(account_id, '120987654321') }}"
    namespace: "{{ k8s_namespace }}"
    service_account: "{{ k8s_service_account }}"
    tags:
      'foo': 'bar'
    state: absent
  register: pod_identity_result
  variables:
    account_id: "{{ (pod_identity_association_role.arn | split(':'))[2] }}"
  environment:
    AWS_DEFAULT_REGION: 'us-east-1'
  check_mode: True

- name: check that eks_pod_identity_association is not changed (check mode)
  assert:
    that:
      - not pod_identity_result.changed

- name: Delete association
  community.aws.eks_pod_identity_association:
    cluster_name: '{{ eks_cluster_name }}'
    role_arn: "{{ pod_identity_association_role.arn }}"
    taregt_role_arn: "{{ pod_identity_association_role.arn | replace(account_id, '120987654321') }}"
    namespace: "{{ k8s_namespace }}"
    service_account: "{{ k8s_service_account }}"
    tags:
      'foo': 'bar'
    state: absent
  register: pod_identity_result
  variables:
    account_id: "{{ (pod_identity_association_role.arn | split(':'))[2] }}"
  environment:
    AWS_DEFAULT_REGION: 'us-east-1'

- name: check that eks_pod_identity_association is not changed
  assert:
    that:
      - not pod_identity_result.changed
